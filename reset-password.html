<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Restablecer contraseña | MICARGA</title>
  <link rel="stylesheet" href="/styles.css" />
  <style>
    body { font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; margin:0; padding:0; background: var(--bg); color:var(--text); }
    .wrapper { max-width:430px; margin: clamp(2rem,6vh,4.5rem) auto; background: var(--card); padding:34px 30px 30px 30px; border-radius: var(--radius-lg,22px); box-shadow: var(--shadow-lg,0 24px 48px rgba(14,47,68,.18)); display:flex; flex-direction:column; gap:18px; }
    h1 { font-size:1.6rem; margin:0 0 4px; color:var(--primary); text-align:center; }
    .intro { margin:0 0 6px; color:var(--muted); font-size:.9rem; text-align:center; }
    label { display:block; font-weight:600; font-size:.75rem; letter-spacing:.5px; text-transform:uppercase; margin:.75rem 0 .35rem; color:var(--primary); }
    input { width:100%; padding:14px 16px; border:1px solid var(--border); background:#fff; border-radius:14px; font-size:.95rem; color:var(--text); transition:border-color .18s, box-shadow .18s, background .18s; }
    input:focus { outline:none; border-color:rgba(58,175,169,.55); box-shadow: var(--ring,0 0 0 3px rgba(58,175,169,.25)); }
    button { width:100%; margin-top:10px; background: linear-gradient(135deg,var(--accent),#ffb347); color:#fff; font-weight:700; padding:14px 1rem; border:0; border-radius:16px; font-size:1rem; cursor:pointer; display:inline-flex; justify-content:center; gap:.5rem; align-items:center; transition:filter .18s, transform .15s; box-shadow:0 12px 26px -6px rgba(243,146,0,.45),0 4px 10px -2px rgba(243,146,0,.30); }
    button:hover { filter:brightness(1.05); }
    button:active { transform:translateY(1px); }
    .error { background:#fff1f1; border:1px solid #f5b4b4; padding:10px 14px; border-radius:14px; font-size:.8rem; margin-top:14px; color:#8a1c1c; }
    .success { background:#f1fbf7; border:1px solid #bde7d5; padding:10px 14px; border-radius:14px; font-size:.85rem; margin-top:14px; color:#0f5132; }
    .password-rules { margin:6px 0 0 0; font-size:.65rem; list-style:none; padding-left:16px; color:var(--muted); line-height:1.15; }
    .password-rules li.ok { color:var(--success); font-weight:600; }
    .hidden { display:none !important; }
    a.back { display:inline-block; margin-top:16px; font-size:.75rem; color:var(--muted); text-decoration:none; text-align:center; }
    a.back:hover { color:var(--primary); }
    .spinner { width:16px; height:16px; border:3px solid rgba(255,255,255,.4); border-top-color:#fff; border-radius:50%; animation:spin .8s linear infinite; }
    @keyframes spin { to { transform:rotate(360deg); } }
    .logo-box { width:74px; height:74px; background:#eaf1f6; border-radius:50%; display:flex; align-items:center; justify-content:center; margin:-18px auto 6px auto; box-shadow:0 2px 12px rgba(14,47,68,.20); }
    .logo-box img { width:58px; height:58px; object-fit:contain; }
    .mini { font-size:11px; color:var(--muted); margin-top:4px; text-align:center; }
    .readonly-email{ font-size:.8rem; background:#fff7e6; border:1px solid #ffe0b3; color:#a35a00; padding:8px 12px; border-radius:10px; text-align:center; margin-top:-4px; }
  </style>
</head>
<body>
  <div class="wrapper" id="card">
  <div class="logo-box"><img src="/assets/logo.jpg" alt="MICARGA"/></div>
    <h1>Restablecer contraseña</h1>
    <p class="intro" id="intro">Ingresá tu nueva contraseña. El enlace expira 1 hora después de haberlo solicitado.</p>
    <div id="emailInfo" class="readonly-email hidden"></div>
    <form id="resetForm" novalidate>
      <input type="hidden" id="token" />
      <!-- Campo de email removido: la cuenta ya está asociada al token -->
      <label for="password">Nueva contraseña</label>
      <input id="password" type="password" autocomplete="new-password" required minlength="8" placeholder="••••••••" />
      <ul class="password-rules" id="rules">
        <li data-rule="len">Mínimo 8 caracteres</li>
        <li data-rule="upper">Al menos una mayúscula</li>
        <li data-rule="lower">Al menos una minúscula</li>
        <li data-rule="num">Al menos un número</li>
      </ul>
      <label for="confirm">Confirmar contraseña</label>
      <input id="confirm" type="password" autocomplete="new-password" required placeholder="••••••••" />
      <button type="submit" id="submitBtn">Cambiar contraseña</button>
      <div id="msg" class="hidden"></div>
      <p class="mini">Una vez cambiada, este enlace dejará de funcionar.</p>
    </form>
    <a href="/" class="back">← Volver al inicio</a>
  </div>
  <script>
  (function(){
    const qs = new URLSearchParams(window.location.search);
    const token = qs.get('token');
    const email = qs.get('email');
    const tokenInput = document.getElementById('token');
    const emailInfo = document.getElementById('emailInfo');
    const passInput = document.getElementById('password');
    const confirmInput = document.getElementById('confirm');
    const form = document.getElementById('resetForm');
    const msgBox = document.getElementById('msg');
    const submitBtn = document.getElementById('submitBtn');
    const rules = document.getElementById('rules');

    if(token) tokenInput.value = token;
    if(email){
      // Mostrar email ofuscado solo como referencia, no editable
      const safe = email.replace(/(^.{2}).+(@.*)/,'$1***$2');
      emailInfo.textContent = 'Cuenta: ' + safe;
      emailInfo.classList.remove('hidden');
    }
    if(!token){
      showMessage('El enlace no contiene token. Solicitá uno nuevo.', true);
      disableForm();
    }

    function showMessage(text, isError){
      msgBox.textContent = text;
      msgBox.className = isError ? 'error' : 'success';
    }
    function disableForm(){
      Array.from(form.elements).forEach(el=> el.disabled = true);
    }

    function validatePasswordVisual(p){
      const tests = {
        len: p.length >= 8,
        upper: /[A-Z]/.test(p),
        lower: /[a-z]/.test(p),
        num: /[0-9]/.test(p)
      };
      Object.entries(tests).forEach(([k, ok])=>{
        const li = rules.querySelector('[data-rule="'+k+'"]');
        if(li) li.classList.toggle('ok', ok);
      });
      return Object.values(tests).every(Boolean);
    }

    passInput.addEventListener('input', ()=> validatePasswordVisual(passInput.value));

    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      msgBox.className = 'hidden';
      const data = {
        token: tokenInput.value.trim(),
        password: passInput.value
      };
      if(email) data.email = email; // opcional, si llega en el enlace
      if(!data.token || !data.password){
        return showMessage('Completá los campos requeridos.', true);
      }
      if(data.password !== confirmInput.value){
        return showMessage('Las contraseñas no coinciden.', true);
      }
      if(!validatePasswordVisual(data.password)){
        return showMessage('La contraseña no cumple los requisitos.', true);
      }
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<span class="spinner"></span> Cambiando...';
      try {
        const res = await fetch('/api/reset-password', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
          credentials: 'include'
        });
        const json = await res.json().catch(()=>({}));
        if(!res.ok){
          throw new Error(json.error || 'Error al restablecer');
        }
        showMessage('Contraseña actualizada correctamente. Ya podés iniciar sesión. Este enlace ya no es válido.', false);
        // Desactivar definitivamente
  Array.from(form.elements).forEach(function(el){ try{ el.disabled = true; }catch{} });
        submitBtn.style.display='none';
        setTimeout(()=>{ window.location.href = '/'; }, 4000);
      } catch(err){
        showMessage(err.message || 'Error desconocido', true);
        submitBtn.innerHTML = 'Cambiar contraseña';
        submitBtn.disabled = false;
      }
    });
  })();
  </script>
</body>
</html>