<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Restablecer contraseña | SENDIX</title>
  <link rel="stylesheet" href="/styles.css" />
  <style>
    body { font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; margin: 0; padding: 0; background:#0f172a; color:#f1f5f9; }
    .container { max-width: 420px; margin: clamp(1rem,5vh,4rem) auto; background:#1e293b; padding:2rem 2.2rem; border-radius: 14px; box-shadow:0 6px 28px -8px rgba(0,0,0,.55), 0 0 0 1px rgba(255,255,255,.04); }
    h1 { font-size:1.35rem; margin:0 0 1.2rem; letter-spacing:.5px; }
    .muted { color:#94a3b8; font-size:.85rem; line-height:1.3; margin-bottom:1.4rem; }
    label { display:block; font-weight:600; font-size:.8rem; text-transform:uppercase; letter-spacing:.7px; margin:1rem 0 .4rem; color:#cbd5e1; }
    input { width:100%; padding:.7rem .85rem; border:1px solid #334155; background:#0f172a; border-radius:8px; color:#f1f5f9; font-size:.95rem; transition:border-color .18s, background-color .18s; }
    input:focus { outline:none; border-color:#6366f1; background:#162032; }
    button { width:100%; margin-top:1.4rem; background:#6366f1; color:#fff; font-weight:600; padding:.85rem 1rem; border:0; border-radius:9px; font-size:.95rem; cursor:pointer; display:inline-flex; justify-content:center; gap:.5rem; align-items:center; transition:background .2s, transform .15s; }
    button:hover { background:#5457e6; }
    button:active { transform:translateY(1px); }
    .error { background:#7f1d1d; border:1px solid #b91c1c; padding:.75rem .9rem; border-radius:8px; font-size:.8rem; margin-top:1rem; color:#fecaca; }
    .success { background:#022c22; border:1px solid #065f46; padding:.75rem .9rem; border-radius:8px; font-size:.8rem; margin-top:1rem; color:#a7f3d0; }
    .password-rules { margin-top:.6rem; font-size:.65rem; list-style:none; padding-left:1rem; color:#94a3b8; line-height:1.15; }
    .password-rules li.ok { color:#10b981; }
    .hidden { display:none !important; }
    a.back { display:inline-block; margin-top:1.4rem; font-size:.75rem; color:#94a3b8; text-decoration:none; }
    a.back:hover { color:#e2e8f0; }
    .spinner { width:16px; height:16px; border:3px solid rgba(255,255,255,.35); border-top-color:#fff; border-radius:50%; animation:spin .8s linear infinite; }
    @keyframes spin { to { transform:rotate(360deg); } }
  </style>
</head>
<body>
  <div class="container">
    <h1>Restablecer contraseña</h1>
    <p class="muted" id="intro">Ingresá tu nueva contraseña. El enlace expira 1 hora después de haberlo solicitado.</p>
    <form id="resetForm" novalidate>
      <input type="hidden" id="token" />
      <label for="email">Email</label>
      <input id="email" type="email" autocomplete="email" required />
      <label for="password">Nueva contraseña</label>
      <input id="password" type="password" autocomplete="new-password" required minlength="8" />
      <ul class="password-rules" id="rules">
        <li data-rule="len">Mínimo 8 caracteres</li>
        <li data-rule="upper">Al menos una mayúscula</li>
        <li data-rule="lower">Al menos una minúscula</li>
        <li data-rule="num">Al menos un número</li>
      </ul>
      <label for="confirm">Confirmar contraseña</label>
      <input id="confirm" type="password" autocomplete="new-password" required />
      <button type="submit" id="submitBtn">Cambiar contraseña</button>
      <div id="msg" class="hidden"></div>
    </form>
    <a href="/" class="back">Volver al inicio</a>
  </div>
  <script>
  (function(){
    const qs = new URLSearchParams(window.location.search);
    const token = qs.get('token');
    const email = qs.get('email');
    const tokenInput = document.getElementById('token');
    const emailInput = document.getElementById('email');
    const passInput = document.getElementById('password');
    const confirmInput = document.getElementById('confirm');
    const form = document.getElementById('resetForm');
    const msgBox = document.getElementById('msg');
    const submitBtn = document.getElementById('submitBtn');
    const rules = document.getElementById('rules');

    if(token) tokenInput.value = token;
    if(email){ emailInput.value = email; }
    if(!token){
      showMessage('El enlace no contiene token. Solicitá uno nuevo.', true);
      disableForm();
    }

    function showMessage(text, isError){
      msgBox.textContent = text;
      msgBox.className = isError ? 'error' : 'success';
    }
    function disableForm(){
      Array.from(form.elements).forEach(el=> el.disabled = true);
    }

    function validatePasswordVisual(p){
      const tests = {
        len: p.length >= 8,
        upper: /[A-Z]/.test(p),
        lower: /[a-z]/.test(p),
        num: /[0-9]/.test(p)
      };
      Object.entries(tests).forEach(([k, ok])=>{
        const li = rules.querySelector('[data-rule="'+k+'"]');
        if(li) li.classList.toggle('ok', ok);
      });
      return Object.values(tests).every(Boolean);
    }

    passInput.addEventListener('input', ()=> validatePasswordVisual(passInput.value));

    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      msgBox.className = 'hidden';
      const data = {
        email: emailInput.value.trim(),
        token: tokenInput.value.trim(),
        password: passInput.value
      };
      if(!data.email || !data.token || !data.password){
        return showMessage('Completá todos los campos.', true);
      }
      if(data.password !== confirmInput.value){
        return showMessage('Las contraseñas no coinciden.', true);
      }
      if(!validatePasswordVisual(data.password)){
        return showMessage('La contraseña no cumple los requisitos.', true);
      }
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<span class="spinner"></span> Cambiando...';
      try {
        const res = await fetch('/api/reset-password', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
          credentials: 'include'
        });
        const json = await res.json().catch(()=>({}));
        if(!res.ok){
          throw new Error(json.error || 'Error al restablecer');
        }
        showMessage('Contraseña actualizada correctamente. Ya podés iniciar sesión.', false);
        form.reset();
        validatePasswordVisual('');
        submitBtn.innerHTML = 'Cambiar contraseña';
        submitBtn.disabled = false;
      } catch(err){
        showMessage(err.message || 'Error desconocido', true);
        submitBtn.innerHTML = 'Cambiar contraseña';
        submitBtn.disabled = false;
      }
    });
  })();
  </script>
</body>
</html>