// src/resetPassword.ts (adaptado para Resend)
import express from "express";
import { PrismaClient } from "@prisma/client";
import crypto from "crypto";
import bcrypt from "bcryptjs";
import { Resend } from "resend";

const router = express.Router();
const prisma = new PrismaClient();

const resend = new Resend(process.env.RESEND_API_KEY);
const FROM_EMAIL = process.env.RESEND_FROM || "no-reply@sendix.com";

function generateToken(): string {
  return crypto.randomBytes(32).toString("hex");
}

// POST /api/forgot-password
router.post("/forgot-password", async (req, res) => {
  const { email } = req.body;
  if (!email) return res.status(400).json({ error: "Falta el email" });

  const user = await prisma.usuario.findUnique({ where: { email: email.toLowerCase() } });
  if (!user) return res.status(200).json({ ok: true });

  const token = generateToken();
  const hash = await bcrypt.hash(token, 10);
  const expires = new Date(Date.now() + 1000 * 60 * 60);

  await prisma.passwordReset.create({
    data: {
      userId: user.id,
      tokenHash: hash,
      expiresAt: expires
    }
  });

  const resetLink = `https://sendix-web.onrender.com/reset-password?token=${token}&email=${encodeURIComponent(email)}`;

  console.log("üì§ Enviando mail a:", email);
  console.log("RESEND_API_KEY:", process.env.RESEND_API_KEY ? "OK" : "FALTA");
  console.log("Reset link:", resetLink);

  try {
    await resend.emails.send({
      from: `SENDIX <${FROM_EMAIL}>`,
      to: email,
      subject: "Recuperaci√≥n de contrase√±a - SENDIX",
      html: `<p>Hola ${user.name || ""},</p>
             <p>Para restablecer tu contrase√±a, hac√© clic en el siguiente enlace:</p>
             <p><a href="${resetLink}">${resetLink}</a></p>
             <p>Este enlace es v√°lido por 1 hora.</p>`
    });
  } catch (err) {
    console.error("‚ùå Error al enviar el email:", err);
    return res.status(500).json({ error: "No se pudo enviar el mail de recuperaci√≥n." });
  }

  res.json({ ok: true });
});

// POST /api/reset-password
router.post("/reset-password", async (req, res) => {
  const { email, token, password } = req.body;
  if (!email || !token || !password) return res.status(400).json({ error: "Faltan campos" });

  const user = await prisma.usuario.findUnique({ where: { email: email.toLowerCase() } });
  if (!user) return res.status(400).json({ error: "Usuario inv√°lido" });

  const records = await prisma.passwordReset.findMany({
    where: { userId: user.id, usedAt: null },
    orderBy: { createdAt: "desc" }
  });

  const valid = records.find(r => r.expiresAt > new Date() && bcrypt.compareSync(token, r.tokenHash));
  if (!valid) return res.status(400).json({ error: "Token inv√°lido o expirado" });

  const newHash = await bcrypt.hash(password, 10);
  await prisma.usuario.update({ where: { id: user.id }, data: { passwordHash: newHash } });
  await prisma.passwordReset.update({ where: { id: valid.id }, data: { usedAt: new Date() } });

  res.json({ ok: true });
});

export default router;